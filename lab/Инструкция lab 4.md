# –ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é Telegram –±–æ—Ç–æ–≤ –Ω–∞ Python

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ
1. [–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è](#–æ—Å–Ω–æ–≤–Ω—ã–µ-–ø–æ–Ω—è—Ç–∏—è)
2. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-–æ–∫—Ä—É–∂–µ–Ω–∏—è)
3. [–°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ –±–æ—Ç–∞](#—Å–æ–∑–¥–∞–Ω–∏–µ-–ø–µ—Ä–≤–æ–≥–æ-–±–æ—Ç–∞)
4. [–¢–∏–ø—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤](#—Ç–∏–ø—ã-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤)
5. [–†–∞–±–æ—Ç–∞ —Å —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏](#—Ä–∞–±–æ—Ç–∞-—Å-—Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏)
6. [–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö](#–±–∞–∑–∞-–¥–∞–Ω–Ω—ã—Ö)
7. [–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ](#—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ)
8. [–õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏](#–ª—É—á—à–∏–µ-–ø—Ä–∞–∫—Ç–∏–∫–∏)

---

## –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è

### –ß—Ç–æ —Ç–∞–∫–æ–µ Telegram Bot API?
Telegram Bot API - —ç—Ç–æ HTTP-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–æ—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç:
- –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∏ –ø–æ–ª—É—á–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
- –†–∞–±–æ—Ç–∞—Ç—å —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞–º–∏
- –£–ø—Ä–∞–≤–ª—è—Ç—å –≥—Ä—É–ø–ø–∞–º–∏ –∏ –∫–∞–Ω–∞–ª–∞–º–∏
- –†–∞–±–æ—Ç–∞—Ç—å —Å —Ñ–∞–π–ª–∞–º–∏ –∏ –º–µ–¥–∏–∞

### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –±–æ—Ç–∞:
- **–¢–æ–∫–µ–Ω** - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–æ—Ç–∞
- **Webhook/Polling** - —Å–ø–æ—Å–æ–±—ã –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- **–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏** - —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- **–ö–æ–Ω—Ç–µ–∫—Å—Ç** - –æ–±—ä–µ–∫—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –≤—ã–∑–æ–≤–∞–º–∏

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ Python
python --version
# Python 3.8+

# –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
python -m venv bot_env
source bot_env/bin/activate  # Linux/Mac
# –∏–ª–∏
bot_env\Scripts\activate  # Windows
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫
```bash
# –û—Å–Ω–æ–≤–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
pip install python-telegram-bot

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª–µ–∑–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
pip install python-dotenv     # –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
pip install requests          # –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
pip install sqlite3           # –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
pip install aiohttp           # –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
```

### 3. –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞
```
my_telegram_bot/
‚îú‚îÄ‚îÄ bot.py              # –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –±–æ—Ç–∞
‚îú‚îÄ‚îÄ config.py           # –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ database.py         # —Ä–∞–±–æ—Ç–∞ —Å –ë–î
‚îú‚îÄ‚îÄ handlers/           # –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ commands.py
‚îÇ   ‚îî‚îÄ‚îÄ messages.py
‚îú‚îÄ‚îÄ keyboards.py        # –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îú‚îÄ‚îÄ requirements.txt    # –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îî‚îÄ‚îÄ .env               # –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```

---

## –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ –±–æ—Ç–∞

### –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
1. –ù–∞–π—Ç–∏ @BotFather –≤ Telegram
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å `/newbot`
3. –í—ã–±—Ä–∞—Ç—å –∏–º—è –±–æ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "My Test Bot")
4. –í—ã–±—Ä–∞—Ç—å username (–æ–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ `bot`, –Ω–∞–ø—Ä–∏–º–µ—Ä, "my_test_bot")
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω

### –®–∞–≥ 2: –ë–∞–∑–æ–≤—ã–π –∫–æ–¥ –±–æ—Ç–∞
```python
# bot.py
import logging
import os
from telegram import Update
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    filters,
    ContextTypes
)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

class TelegramBot:
    def __init__(self, token: str):
        self.application = Application.builder().token(token).build()
        self.setup_handlers()
    
    def setup_handlers(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π"""
        
        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
        self.application.add_handler(CommandHandler("start", self.start_command))
        
        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help
        self.application.add_handler(CommandHandler("help", self.help_command))
        
        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        self.application.add_handler(
            MessageHandler(filters.TEXT & ~filters.COMMAND, self.echo_message)
        )
        
        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
        self.application.add_error_handler(self.error_handler)
    
    async def start_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start"""
        user = update.effective_user
        welcome_text = f"""
–ü—Ä–∏–≤–µ—Ç, {user.first_name}! üëã

–Ø –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –±–æ—Ç. –í–æ—Ç —á—Ç–æ —è —É–º–µ—é:
/start - –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É
/help - –ø–æ–º–æ—â—å
        """
        await update.message.reply_text(welcome_text)
    
    async def help_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /help"""
        help_text = """
üìö –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:

/start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º
/help - –ü–æ–ª—É—á–∏—Ç—å —Å–ø—Ä–∞–≤–∫—É

–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å –º–Ω–µ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏ —è –µ–≥–æ –ø–æ–≤—Ç–æ—Ä—é!
        """
        await update.message.reply_text(help_text)
    
    async def echo_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–≠—Ö–æ-–æ—Ç–≤–µ—Ç –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        user_message = update.message.text
        response = f"–í—ã —Å–∫–∞–∑–∞–ª–∏: {user_message}"
        await update.message.reply_text(response)
    
    async def error_handler(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫"""
        logger.error(f"–û—à–∏–±–∫–∞: {context.error}")
    
    def run(self):
        """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
        print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
        self.application.run_polling()

if __name__ == "__main__":
    # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
    BOT_TOKEN = os.getenv("BOT_TOKEN")
    
    if not BOT_TOKEN:
        print("–û—à–∏–±–∫–∞: BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
        exit(1)
    
    bot = TelegramBot(BOT_TOKEN)
    bot.run()
```

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```python
# config.py
import os
from dotenv import load_dotenv

load_dotenv()

class Config:
    """–ö–ª–∞—Å—Å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–æ—Ç–∞"""
    
    # –¢–æ–∫–µ–Ω –±–æ—Ç–∞
    BOT_TOKEN = os.getenv("BOT_TOKEN")
    
    # ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    ADMIN_ID = int(os.getenv("ADMIN_ID", 0))
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    DATABASE_URL = os.getenv("DATABASE_URL", "sqlite:///bot.db")
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–µ–±—Ö—É–∫–∞ (–¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)
    WEBHOOK_URL = os.getenv("WEBHOOK_URL", "")
    WEBHOOK_PORT = int(os.getenv("WEBHOOK_PORT", 8443))
    
    @classmethod
    def validate(cls):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫"""
        if not cls.BOT_TOKEN:
            raise ValueError("BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")

# .env —Ñ–∞–π–ª
BOT_TOKEN=your_actual_bot_token_here
ADMIN_ID=123456789
DATABASE_URL=sqlite:///bot.db
```

---

## –¢–∏–ø—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

### 1. CommandHandler - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥
```python
async def custom_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –∫–æ–º–∞–Ω–¥—ã"""
    await update.message.reply_text("–≠—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∫–æ–º–∞–Ω–¥–∞!")

# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
application.add_handler(CommandHandler("custom", custom_command))
```

### 2. MessageHandler - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
```python
# –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç
text_handler = MessageHandler(filters.TEXT, text_handler_function)

# –¢–æ–ª—å–∫–æ —Ñ–æ—Ç–æ
photo_handler = MessageHandler(filters.PHOTO, photo_handler_function)

# –¢–æ–ª—å–∫–æ –¥–æ–∫—É–º–µ–Ω—Ç—ã
document_handler = MessageHandler(filters.DOCUMENT, document_handler_function)

# –ö–æ–º–±–∏–Ω–∞—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
text_and_photo = MessageHandler(
    filters.TEXT | filters.PHOTO, 
    combined_handler
)
```

### 3. CallbackQueryHandler - –æ–±—Ä–∞–±–æ—Ç–∫–∞ inline –∫–Ω–æ–ø–æ–∫
```python
from telegram import InlineKeyboardButton, InlineKeyboardMarkup

async def show_options(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑–∞—Ç—å inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É"""
    keyboard = [
        [InlineKeyboardButton("–û–ø—Ü–∏—è 1", callback_data="option_1")],
        [InlineKeyboardButton("–û–ø—Ü–∏—è 2", callback_data="option_2")],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        "–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏—é:",
        reply_markup=reply_markup
    )

async def handle_button_click(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ inline –∫–Ω–æ–ø–∫—É"""
    query = update.callback_query
    await query.answer()  # –í–∞–∂–Ω–æ: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ callback
    
    if query.data == "option_1":
        await query.edit_message_text("–í—ã –≤—ã–±—Ä–∞–ª–∏ –æ–ø—Ü–∏—é 1!")
    elif query.data == "option_2":
        await query.edit_message_text("–í—ã –≤—ã–±—Ä–∞–ª–∏ –æ–ø—Ü–∏—é 2!")

# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
application.add_handler(CommandHandler("options", show_options))
application.add_handler(CallbackQueryHandler(handle_button_click))
```

### 4. PollHandler - —Ä–∞–±–æ—Ç–∞ —Å –æ–ø—Ä–æ—Å–∞–º–∏
```python
async def handle_poll(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø—Ä–æ—Å–æ–≤"""
    poll = update.poll
    logger.info(f"–ü–æ–ª—É—á–µ–Ω –æ–ø—Ä–æ—Å: {poll.question}")

application.add_handler(PollHandler(handle_poll))
```

---

## –†–∞–±–æ—Ç–∞ —Å —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏

### ConversationHandler –¥–ª—è –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
```python
from telegram.ext import ConversationHandler

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è
NAME, AGE, CITY = range(3)

class ConversationBot:
    def __init__(self, application):
        self.application = application
        self.setup_conversation()
    
    def setup_conversation(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–Ω–æ–≥–æ—à–∞–≥–æ–≤–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞"""
        
        conv_handler = ConversationHandler(
            entry_points=[CommandHandler('register', self.start_registration)],
            states={
                NAME: [MessageHandler(filters.TEXT, self.get_name)],
                AGE: [MessageHandler(filters.TEXT, self.get_age)],
                CITY: [MessageHandler(filters.TEXT, self.get_city)],
            },
            fallbacks=[CommandHandler('cancel', self.cancel_registration)],
        )
        
        self.application.add_handler(conv_handler)
    
    async def start_registration(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ù–∞—á–∞–ª–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"""
        await update.message.reply_text(
            "–î–∞–≤–∞–π—Ç–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≤–∞—Å!\n"
            "–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?"
        )
        return NAME
    
    async def get_name(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏"""
        context.user_data['name'] = update.message.text
        await update.message.reply_text("–°–∫–æ–ª—å–∫–æ –≤–∞–º –ª–µ—Ç?")
        return AGE
    
    async def get_age(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–∞"""
        try:
            age = int(update.message.text)
            context.user_data['age'] = age
            await update.message.reply_text("–ò–∑ –∫–∞–∫–æ–≥–æ –≤—ã –≥–æ—Ä–æ–¥–∞?")
            return CITY
        except ValueError:
            await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ!")
            return AGE
    
    async def get_city(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"""
        context.user_data['city'] = update.message.text
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        name = context.user_data['name']
        age = context.user_data['age']
        city = context.user_data['city']
        
        summary = f"""
‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!

üìù –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:
‚Ä¢ –ò–º—è: {name}
‚Ä¢ –í–æ–∑—Ä–∞—Å—Ç: {age}
‚Ä¢ –ì–æ—Ä–æ–¥: {city}

–°–ø–∞—Å–∏–±–æ –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é!
        """
        
        await update.message.reply_text(summary)
        
        # –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        context.user_data.clear()
        
        return ConversationHandler.END
    
    async def cancel_registration(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û—Ç–º–µ–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"""
        await update.message.reply_text("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.")
        context.user_data.clear()
        return ConversationHandler.END
```

---

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –†–∞–±–æ—Ç–∞ —Å SQLite
```python
# database.py
import sqlite3
import logging
from datetime import datetime

logger = logging.getLogger(__name__)

class DatabaseManager:
    def __init__(self, db_path: str = "bot_database.db"):
        self.db_path = db_path
        self.init_database()
    
    def get_connection(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö"""
        conn = sqlite3.connect(self.db_path)
        conn.row_factory = sqlite3.Row  # –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–æ–ª–æ–Ω–∫–∞–º –ø–æ –∏–º–µ–Ω–∏
        return conn
    
    def init_database(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü"""
        with self.get_connection() as conn:
            # –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            conn.execute('''
                CREATE TABLE IF NOT EXISTS users (
                    user_id INTEGER PRIMARY KEY,
                    username TEXT,
                    first_name TEXT,
                    last_name TEXT,
                    language_code TEXT,
                    is_bot BOOLEAN,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    last_activity TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )
            ''')
            
            # –¢–∞–±–ª–∏—Ü–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
            conn.execute('''
                CREATE TABLE IF NOT EXISTS messages (
                    message_id INTEGER PRIMARY KEY AUTOINCREMENT,
                    user_id INTEGER,
                    text TEXT,
                    message_date TIMESTAMP,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    FOREIGN KEY (user_id) REFERENCES users (user_id)
                )
            ''')
            
            # –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
            conn.execute('''
                CREATE TABLE IF NOT EXISTS user_data (
                    user_id INTEGER PRIMARY KEY,
                    age INTEGER,
                    city TEXT,
                    preferences TEXT,
                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    FOREIGN KEY (user_id) REFERENCES users (user_id)
                )
            ''')
    
    def save_user(self, user):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        with self.get_connection() as conn:
            conn.execute('''
                INSERT OR REPLACE INTO users 
                (user_id, username, first_name, last_name, language_code, is_bot, last_activity)
                VALUES (?, ?, ?, ?, ?, ?, ?)
            ''', (
                user.id,
                user.username,
                user.first_name,
                user.last_name,
                user.language_code,
                user.is_bot,
                datetime.now()
            ))
    
    def save_message(self, user_id, text, message_date):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        with self.get_connection() as conn:
            conn.execute('''
                INSERT INTO messages (user_id, text, message_date)
                VALUES (?, ?, ?)
            ''', (user_id, text, message_date))
    
    def get_user_stats(self, user_id):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        with self.get_connection() as conn:
            # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
            message_count = conn.execute(
                'SELECT COUNT(*) FROM messages WHERE user_id = ?',
                (user_id,)
            ).fetchone()[0]
            
            # –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
            last_activity = conn.execute(
                'SELECT last_activity FROM users WHERE user_id = ?',
                (user_id,)
            ).fetchone()[0]
            
            return {
                'message_count': message_count,
                'last_activity': last_activity
            }
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ—Ç–∞
```python
# bot_with_db.py
from database import DatabaseManager

class BotWithDatabase:
    def __init__(self, token: str):
        self.application = Application.builder().token(token).build()
        self.db = DatabaseManager()
        self.setup_handlers()
    
    async def start_with_db(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ö–æ–º–∞–Ω–¥–∞ /start —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –ë–î"""
        user = update.effective_user
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
        self.db.save_user(user)
        
        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        stats = self.db.get_user_stats(user.id)
        
        welcome_text = f"""
–ü—Ä–∏–≤–µ—Ç, {user.first_name}! üëã

üìä –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {stats['message_count']}
‚Ä¢ –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {stats['last_activity']}
        """
        
        await update.message.reply_text(welcome_text)
    
    async def save_user_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        user = update.effective_user
        message_text = update.message.text
        message_date = update.message.date
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ
        self.db.save_user(user)
        self.db.save_message(user.id, message_text, message_date)
        
        await update.message.reply_text("–°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!")
```

---

## –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### 1. –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ (Polling)
```python
# –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
if __name__ == "__main__":
    bot = TelegramBot("YOUR_TOKEN")
    bot.run()  # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç polling
```

### 2. –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (Webhook)
```python
# webhook_bot.py
import os
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters

class WebhookBot:
    def __init__(self, token: str, webhook_url: str):
        self.application = Application.builder().token(token).build()
        self.webhook_url = webhook_url
        self.setup_handlers()
    
    async def set_webhook(self):
        """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook"""
        await self.application.bot.set_webhook(
            url=self.webhook_url,
            # certificate=open('/path/to/cert.pem', 'rb')  # –¥–ª—è HTTPS
        )
    
    def run_webhook(self, port: int = 8443):
        """–ó–∞–ø—É—Å–∫ —Å webhook"""
        self.application.run_webhook(
            listen="0.0.0.0",
            port=port,
            webhook_url=self.webhook_url,
            # key='private.key',    # –¥–ª—è HTTPS
            # certificate='cert.pem', # –¥–ª—è HTTPS
        )

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
if __name__ == "__main__":
    bot = WebhookBot(
        token=os.getenv("BOT_TOKEN"),
        webhook_url="https://yourdomain.com/webhook"
    )
    bot.run_webhook(port=8443)
```

### 3. Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è
```dockerfile
# Dockerfile
FROM python:3.11-slim

WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
COPY requirements.txt .

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN pip install --no-cache-dir -r requirements.txt

# –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–¥
COPY . .

# –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
RUN useradd -m -u 1000 botuser
USER botuser

# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
CMD ["python", "bot.py"]
```

```yaml
# docker-compose.yml
version: '3.8'

services:
  telegram-bot:
    build: .
    environment:
      - BOT_TOKEN=${BOT_TOKEN}
      - DATABASE_URL=sqlite:///bot.db
    volumes:
      - ./data:/app/data
    restart: unless-stopped
```

---

## –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### 1. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async def admin_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    admin_id = int(os.getenv("ADMIN_ID"))
    
    if update.effective_user.id != admin_id:
        await update.message.reply_text("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã")
        return
    
    # –õ–æ–≥–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    await update.message.reply_text("–ê–¥–º–∏–Ω –∫–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞")
```

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
```python
async def robust_message_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        # –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
        await process_message(update, context)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
        await update.message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

async def global_error_handler(update: object, context: ContextTypes.DEFAULT_TYPE):
    """–ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫"""
    error = context.error
    
    if isinstance(error, telegram.error.NetworkError):
        logger.warning("–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é")
    elif isinstance(error, telegram.error.TimedOut):
        logger.warning("–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞")
    else:
        logger.error(f"–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {error}")
```

### 3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```python
import logging
import sys

def setup_logging():
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è"""
    
    # –§–æ—Ä–º–∞—Ç—Ç–µ—Ä
    formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ñ–∞–π–ª–∞
    file_handler = logging.FileHandler('bot.log', encoding='utf-8')
    file_handler.setFormatter(formatter)
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setFormatter(formatter)
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ –ª–æ–≥–≥–µ—Ä–∞
    logging.basicConfig(
        level=logging.INFO,
        handlers=[file_handler, console_handler]
    )
```

### 4. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
```python
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
import functools
from typing import Dict, Any

def cache_user_data(func):
    """–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    cache: Dict[int, Any] = {}
    
    @functools.wraps(func)
    async def wrapper(update: Update, context: ContextTypes.DEFAULT_TYPE):
        user_id = update.effective_user.id
        
        if user_id in cache:
            return cache[user_id]
        
        result = await func(update, context)
        cache[user_id] = result
        return result
    
    return wrapper
```

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

### –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã –¥–ª—è –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:

1. **–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è** –¥–ª—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
2. **–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è** –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö** –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏
4. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –±–æ—Ç–∞** –ø–µ—Ä–µ–¥ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ–º –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω
5. **–°–æ–±–ª—é–¥–∞–π—Ç–µ –ª–∏–º–∏—Ç—ã Telegram API** (–Ω–µ –±–æ–ª–µ–µ 30 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–µ–∫—É–Ω–¥—É)
6. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –º–µ—Ç–æ–¥** –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (Polling –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, Webhook –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)
